## MatrixOS – Additions, Tweaks, and Fixes

### Matrix Command Security Summary

Matrix has been refactored to close all direct command (cmd_*) entry points.
Only signed and encrypted packets are now accepted by the core or any swarm agent.

1. Command Flow and Verification

2. Ingress Agents as Gateways

3. All inbound communication—whether from the GUI, HTTPS, or WebSocket—is first received by an ingress agent such as matrix_https.

4. These ingress agents no longer call cmd_* handlers directly.

### Every incoming payload must be:

- Encrypted with the recipient’s public key from the Phoenix Vault.

- Signed with the sender’s private key from the Phoenix Vault.

- Verified against Matrix’s trust chain using its public key.

### cmd_the_source as the Single Entry Command

1. cmd_the_source is the only open command exposed to ingress agents.

2. It acts as a decryption and signature-verification gate.

3. Once the payload is decrypted and verified, it forwards the unwrapped inner command (for example cmd_replace_source, cmd_update_agent, etc.) internally to Matrix.

This ensures that even if an ingress agent is reached directly, the payload cannot trigger a command without valid cryptographic proof of origin.

Encrypted Internal Delegation

Internal agent-to-agent communication—such as updates or tree propagation—uses cmd_deliver_agent_tree_to_child.

Each agent encrypts its delegated data using its own keypair, which is issued, signed, and managed by Matrix.

- This guarantees that no agent can impersonate another or alter delegated data, since only Matrix can authorize or regenerate the keypairs.

Result

- No command within Matrix can be invoked through a raw or unsigned packet as long as you don't disable encryption using the matrixd --encryption-off which disables agent-to-agent encryption; if you shut encryption off all agent_tree directives and packets will be plain text.

- Every operational command must originate from a verified agent or cockpit through a signed and encrypted channel.


### Additions

- Introduced ReapStatusHandlerMixin for stage-based reaper transaction orchestration.

- Added automatic Assassin Manager to deploy and coordinate reaper agents.

- Added transaction watcher to automatically advance restart/delete stages when quorum met.

- Added live agent replace pipeline (cmd_replace_source) with integrity verification and encrypted confirmation.

- Added agent configuration patch command (cmd_update_agent) supporting live push.

- Added agent injection command (cmd_inject_agents) with transaction and parent delegation logic.

- Added hot-swap mechanism (_cmd_hotswap_agent) for dynamic code replacement and optional restart.

- Added structured HTTPS ingress agent with Flask server, mTLS validation, SPKI pinning, and signature checks.

- Added asynchronous WebSocket relay with signed handshake verification.

- Added verify_identity to boot_agent used gate agents, depending on if encryption is on

- Added shutdown_now called from enforce_singleton, which forces the agent a soft force down

### Tweaks

- Updated all command handlers to include explicit confirmation and transaction metadata.

- Refactored agent tree delegation routines to include parent re-delegation after replace or update.

- Improved reaper escalation logic for dead processes using psutil status validation.

- Refined process cleanup logic to delete “die” cookies and stale pods.

- Introduced print logging for all packet stage transitions.

### Fixes

- Fixed missing QApplication context in cockpit calls from subprocesses.

- Fixed double initialization of reaper watcher causing concurrent tree writes.

- Fixed recursive agent tree rebuild errors by adding child lock protection.

- Fixed watchdog crashes by isolating thread exceptions and enforcing timed backoffs.

- Fixed cmd_delete_agent aborts caused by missing parent lookup.

- Fixed process zombies by enforcing os.kill(pid, 15) fallback and verification.

- Fixed reaper escalation logic to remove die file after successful termination.

- Fixed deadlock in packet pipeline by queuing _reaper_transaction_watcher() instead of direct recursion.

- Fixed Python font rendering on Windows in text widgets by setting default fonts.

- Fixed identity keypair mismatch checks and improved matrix signature validation.