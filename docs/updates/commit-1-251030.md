## MatrixOS WebSocket Refit ‚Äî Secure Transport & GUI Broadcast Integration

### Summary
This update refactors the Matrix WebSocket agent into a secure, stateful communication hub for Phoenix Cockpit and other GUI endpoints.
It adds verified handshakes, encrypted payload transport, structured broadcasting, and the new swarm_feed.alert delivery path.

### Security & Cryptography

- Handshake Validation

 - Added full SPKI pin verification for client TLS certs.

 - Implemented allowlist IP enforcement for incoming WebSocket connections.

 - Added handshake signature verification (crypto_utils.verify_signed_payload) on ‚Äúhello‚Äù packets to authenticate GUI clients.

- Cryptographic Sealing

 - Introduced _secure_payload() for outbound packets:
encrypts content with the GUI‚Äôs public key and signs the wrapper with the Matrix private key.

 - Integrated asymmetric key loading from vault directive:

 - privkey ‚Üí _signing_key_obj

 - remote_pubkey ‚Üí _peer_pub_key_pem

 - Added serial + timestamp metadata to prevent replay.

- Signature Handling

 - Enforced digital signature verification for all inbound messages.

 - Denies malformed or stale packets with explicit close reasons (bad signature, bad packet format, stale timestamp).

üì° Core WebSocket Transport

- Async Event Loop

 - Built thread-safe asyncio loop (start_socket_loop) that hosts the TLS WebSocket server.

 - Gracefully handles shutdown signals via _stop_event and loop.stop().

 - Runs process and service heartbeat coroutines for watchdog beaconing.

- Session Management

 - Maintains _sessions dict of active connections (session_id ‚Üí websocket).

 - Each session stores metadata (agent name, start time, ws handle).

 - Implements periodic ping keepalive to prevent stale sockets.

- Broadcast & Routing

 - Rebuilt _cmd_broadcast() to send sealed JSON packets to all connected sessions concurrently.

 - cmd_rpc_route() now:

  - Directs packets to a single session if session_id provided.

  - Falls back to swarm broadcast otherwise.

 - Added thread-safe asyncio.run_coroutine_threadsafe() dispatch for all loop writes.

## Alert & GUI Integration

- cmd_send_alert_msg()

  - New handler that transforms internal hive alerts into Phoenix GUI feed messages.

  - Standardizes structure:

```json
{
  "handler": "swarm_feed.alert",
  "origin": "<agent>",
  "timestamp": <epoch>,
  "id": "<uuid4>",
  "content": {
    "formatted_msg": "<message>",
    "level": "<INFO|WARN|ERROR|ALERT>",
  }
}
```

 - Broadcasts via _cmd_broadcast() to all GUI clients.

 - Enables real-time swarm alert propagation with signed integrity.

- update_broadcast_flag()


## Reliability & Diagnostics

- Added extensive logging for connection lifecycle:

  - [WS][CONNECT], [WS][HELLO], [WS][MESSAGE RECEIVED], [WS][DISCONNECT].

- Added structured exception handling in websocket_handler() to guarantee graceful client closure.

- Implemented watchdog heartbeats (emit_process_beacon, emit_service_beacon) for liveness telemetry.

- Prevented stale thread resurrection via _lock and _config comparison in worker().

## Code Modernization

- Converted blocking send loops into async coroutines.

- Unified packet schema for all outbound communications.

- Replaced legacy flat key usage with nested config.security.signing structure.

- Simplified error surfaces: any unhandled exception logs with full trace under [WS][FATAL].

# Outcome

MatrixOS WebSocket now:

- Provides authenticated, encrypted, and signed communication to all GUI clients.

- Supports real-time broadcast of swarm alerts directly into Phoenix‚Äôs feed system.

- Handles connection churn and handshake denial gracefully.

- Integrates seamlessly with Phoenix‚Äôs new session and signal model.

- Replaces ad-hoc plaintext websockets with a hardened, multi-session TLS transport.
